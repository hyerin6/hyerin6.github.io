<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>제대로 알고 써야하는 synchronized</title>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" type="text/css">

  <!-- Font -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href='//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css' rel='stylesheet' type='text/css'>
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Hyerin Blog" href="/feed.xml" />
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>제대로 알고 써야하는 synchronized | Hyerin Blog</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="제대로 알고 써야하는 synchronized" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="자바 성능 튜닝 이야기 story 8" />
<meta property="og:description" content="자바 성능 튜닝 이야기 story 8" />
<link rel="canonical" href="http://localhost:4000/2020-06-07/%EC%9E%90%EB%B0%94%EC%84%B1%EB%8A%A5%ED%8A%9C%EB%8B%9D-synchronized/" />
<meta property="og:url" content="http://localhost:4000/2020-06-07/%EC%9E%90%EB%B0%94%EC%84%B1%EB%8A%A5%ED%8A%9C%EB%8B%9D-synchronized/" />
<meta property="og:site_name" content="Hyerin Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-07T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="제대로 알고 써야하는 synchronized" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2020-06-07/%EC%9E%90%EB%B0%94%EC%84%B1%EB%8A%A5%ED%8A%9C%EB%8B%9D-synchronized/","headline":"제대로 알고 써야하는 synchronized","dateModified":"2020-06-07T00:00:00+09:00","datePublished":"2020-06-07T00:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020-06-07/%EC%9E%90%EB%B0%94%EC%84%B1%EB%8A%A5%ED%8A%9C%EB%8B%9D-synchronized/"},"@type":"BlogPosting","description":"자바 성능 튜닝 이야기 story 8","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8RJ9ZZ1LSQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8RJ9ZZ1LSQ', { 'anonymize_ip': false});
</script>


</head>

<body>
  <div class="content-container">
    <header>
  <div class="header-small">
    <a href="http://localhost:4000">Hyerin Blog</a>
  </div>
</header>
<div class="post">
  <div class="post-title">제대로 알고 써야하는 synchronized</div>
  <br />
  <span class="post-date">
    <time>07 Jun 2020</time>
  </span>

  <div class="post-tag">
    <ul>
      
      <li>
        <a href="http://localhost:4000/tags#java">
          <span>java</span>
        </a>
      </li>
      
      
    </ul>
  </div>

  <h1 id="자바에서-스레드는-어떻게-사용하나">자바에서 스레드는 어떻게 사용하나?</h1>
<p>WAS는 여러 개의 스레드가 동작하도록 되어 있다. synchronized를 자주 사용한다.           <br />
synchronized를 쓴다고 무조건 안정적인 것은 아니며 성능에 영향을 미치는 부분도 있다.</p>

<p><br /></p>

<h2 id="프로세스와-스레드">프로세스와 스레드</h2>
<p>클래스를 하나 수행시키거나 WAS를 기동하면 서버에 자바 프로세스가 하나 생성된다.    <br />
하나의 프로세스에는 여러 개의 스레드가 생성된다.    <br />
단일 스레드가 생성되어 종료될 수도 있고, 여러 개의 스레드가 생성되어 수행될 수도 있다.    <br />
프로세스와 스레드의 관계는 1:N 관계라고 보면 된다.</p>

<p>스레드는 가벼운 프로세스라고도 하며, 프로세스에서 만들어 사용하고 있는 메모리를 공유한다.        <br />
그래서 별개의 프로세스가 하나씩 뜨는 것보다는 성능이나 자원 사용에 있어서 많은 도움이 된다.</p>

<p><br /></p>

<h2 id="synchronized를-이해하자">Synchronized를 이해하자.</h2>
<p>웹 기반의 시스템에서 스레드 관련 부분 중 가장 많이 사용하는 것은 synchronized일 것이다.   <br />
synchronized는 동시에 처리한다는 의미로 하나의 객체에 여러 객체가 동시에 접근하여 처리하는 상황에 사용한다.   <br />
하나의 객체에 여러 요청이 동시에 들어오면 한 명씩 들어오라고 해당 메서드나 블록에서 제어하게 된다.</p>

<p>synchronized와 static을 연결해서 생각하면 더욱 복잡해진다.   <br />
synchronized는 절대로 생성자의 식별자로는 사용할 수 없다는 점을 기억하자.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">sampleMethod</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 생략</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sampleBlock</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span><span class="o">(</span><span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 생략</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>간단하게 synchronized라는 식별자로 동기화할 수 있다.         <br />
그럼 언제 동기화를 사용해야 할까?</p>

<p>(1) 하나의 객체를 여러 스레드에서 동시에 사용할 경우            <br />
(2) static으로 선언한 객체를 여러 스레드에서 동시에 사용할 경우</p>

<p>위의 경우가 아니면 동기화를 할 필요가 없다.</p>

<p><br />      <br />
<br /></p>

<h2 id="동기화-사용법-1-동일-객체-접근-시">동기화 사용법: (1) 동일 객체 접근 시</h2>
<p>예를들어, 여러 기부자가 어떤 기부금을 처리하는 단체에 기부금을 낸다고 가정하자.</p>

<ul>
  <li>총 기부금 : amount</li>
  <li>기부자 : Contributor</li>
  <li>기부단체 : Contribution</li>
  <li>기부금 받는 창구 : donate()</li>
</ul>

<p><br /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class Contribution {
    private int amount = 0;
    
    public void donate() {
        amount++;
    }
    
    public int getTotal() {
        return amount;
    }
}

public class Contributor extends Thread {
    private Contribution myContribution;
    private String myName;
    
    . . .
    
}
</code></pre></div></div>

<p><br /></p>

<h3 id="동기화하기-전-기부단체-10개-1000원씩-출력">동기화하기 전 기부단체 10개 (1000원씩 출력)</h3>
<p>1인당 1원씩 1,000번 기부하고 기부가 완료되면 전체 기부금을 프린트한다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static void main(String[] args) {
    Contributor[] cts = new Contributor[10];
    
    // 기부자, 단체 초기화 
    for(int i = 0; i &lt; 10; ++i) {
        Contribution group = new Contribution();
        crs[i] = new Contributor(group, "Contributor " + i);
    }
    
    // 기부 실행 
    for(int i = 0; i &lt; 10; ++i) {
        crs[i].start();
    }
}
</code></pre></div></div>

<p>위 코드에서 기부금을 받는 단체인 group 객체를 매번 생성했기 때문에     <br />
10명의 객체가 각기 다른 단체에 기부하게 된다.</p>

<p><br /></p>

<h3 id="동기화하기-전-기부-단체-1개-10000원-출력-x">동기화하기 전 기부 단체 1개 (10,000원 출력 X)</h3>
<p>기부 단체가 하나인 경우 어떻게 될까?</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Contribution group = new Contribution();

for(int i = 0; i &lt; 10; ++i) {
    crs[i] = new Contributor(group, "Contributor " + i);
}
</code></pre></div></div>

<p>총 기부금 금액은 10,000원이 출력되어야 하는데 예상대로 출력되지 않는다.</p>

<p><br /></p>

<h3 id="예상대로-출력되지-않는-이유는">예상대로 출력되지 않는 이유는?</h3>
<p>예상대로라면 1000원씩 기부했기 때문에 총 10,000원이 프린트되어야 하는데  <br />
대부분 10,000원이 프린트되지 않는다.</p>

<p>그 이유는 10개의 Contributor 객체에서 하나의 Contribution 객체의 <code class="language-plaintext highlighter-rouge">donate()</code> 메서드를   <br />
동시에 접근할 수 있도록 되어 있기 때문이다.         <br />
이 오류를 수정하기 위해 <code class="language-plaintext highlighter-rouge">donate()</code> 메서드에 synchronized를 써서 동기화 식별자를 추가해야 한다.</p>

<p>위 예제들을 성능 테스트해보면 필요 없는 부분에 synchronized를 사용하면 약간이지만 성능에 영향을 준다.</p>

<p><br />      <br />
<br /></p>

<h2 id="동기화-사용법-2-static-사용-시">동기화 사용법: (2) static 사용 시</h2>
<p>앞 예제에서 amount를 static으로 선언하고 synchronized를 사용하면 어떻게 될까?    <br />
<br /></p>

<h3 id="동기화-전-기부-단체-10개에-기부하는-경우-synchronized-사용-x">동기화 전: 기부 단체 10개에 기부하는 경우 (synchronized 사용 X)</h3>
<p>총 10,000원이 출력되어야 하는데 원하는 결과가 안나온다.  <br />
각 단체에 기부하는 케이스라 하더라도 amount를 static으로 선언하면 <br />
각 기부 단체에 따로 기부하는 것은 불가능하다.</p>

<p><br /></p>

<h3 id="donate-메서드-동기화-기부-단체-10개에-기부하는-경우-synchronized-사용-o"><code class="language-plaintext highlighter-rouge">donate()</code> 메서드 동기화: 기부 단체 10개에 기부하는 경우 (synchronized 사용 O)</h3>
<p>이번에도 원하는 결과가 나오지 않는다.  <br />
synchronized는 각각의 객체에 대한 동기화를 하는 것이기 때문에  <br />
각각의 단체에 대한 동기화는 되었지만 amount에 대한 동기화는 되지 않는다.</p>

<p><br /></p>

<h3 id="donate-메서드-동기화-static-추가"><code class="language-plaintext highlighter-rouge">donate()</code> 메서드 동기화, static 추가</h3>
<p>amount는 클래스의 변수이지 객체의 변수가 아니다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static synchronized void donate() {
    amount++;
}
</code></pre></div></div>

<p>이제 원하는 대로 결과가 나왔다.</p>

<p><br /></p>

<p>항상 변하는 값에 대해서 static으로 선언하여 사용하면 위험하다.  <br />
synchronized도 꼭 필요할 때만 사용해야 한다.</p>

<p><br /></p>

<h2 id="동기화를-위해서-자바에서-제공하는-것들">동기화를 위해서 자바에서 제공하는 것들</h2>

<p>JDK 5.0부터 추가된 <code class="language-plaintext highlighter-rouge">java.util.concurrent</code> 패키지에 대해서 간단히 알아보자.   <br />
이 패키지에 주요 개념 4가지가 포함되어 있다.</p>

<p>(1) Lock : 실행 중인 스레드를 간단한 방법으로 정지시켰다가 실행시킨다. 상호참조로 인해 발생하는 데드락을 피할 수 있다.</p>

<p>(2) Execute : 스레드를 더 효율적으로 관리할 수 있는 클래스들을 제공한다.</p>

<p>(3) Concurrent 콜렉션 : 앞서 살펴본 콜렉션의 클래스들을 제공한다.</p>

<p>(4) Atomic 변수 : 동기화가 되어 있는 변수를 제공한다. 이 변수를 사용하면, synchronized 식별자를 메서드에 지정할 필요가 없이 사용할 수 있다.</p>

<p><br /></p>

<h2 id="정리">정리</h2>
<p>동일한 객체를 공유하거나, static을 사용한 변수를 공유할 경우 반드시 synchronized를 사용해야 한다.   <br />
synchronized는 여러 스레드에서 접근하는 것을 막아주는 장점이 있지만, <br />
성능 저하가 발생한다는 단점이 있다.</p>

<p><br /></p>


  <br />

  <hr />

  <br />
  <script src="https://utteranc.es/client.js"
        repo="hyerin6/hyerin6.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
  </script>

</div>


    <!-- Documents about icons are here: http://fontawesome.io/icons/ -->
<div class="footer">
  <hr />

  <div class="footer-link">
    
    <a href="https://github.com/hyerin6"><i class="fa fa-github" aria-hidden="true"></i></a>
    
	
    
    <a href="mailto:hyerinn6@gmail.com"><i class="fa fa-envelope" aria-hidden="true"></i></a>
    
  </div>
  © 2022 Hyerin. All rights reserved.
</div>

<br />
<div class="footer">
    <a style="text-align: center;" href="https://hits.seeyoufarm.com">
      <img style="text-align: center;" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fhyerin6.github.io&count_bg=%23010101&title_bg=%23070707&icon=&icon_color=%23E7E7E7&title=visitors&edge_flat=false"/>
    </a>
</div>
  </div>
</body>
</html>
