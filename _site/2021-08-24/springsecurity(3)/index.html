<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Spring Security + OAuth2.0 + Kakao</title>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" type="text/css">

  <!-- Font -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href='//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css' rel='stylesheet' type='text/css'>
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for Hyerin Blog" href="/feed.xml" />
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Spring Security + OAuth2.0 + Kakao | Hyerin Blog</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Spring Security + OAuth2.0 + Kakao" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Spring OAuth2.0 Kakao Login" />
<meta property="og:description" content="Spring OAuth2.0 Kakao Login" />
<link rel="canonical" href="http://localhost:4000/2021-08-24/springsecurity(3)/" />
<meta property="og:url" content="http://localhost:4000/2021-08-24/springsecurity(3)/" />
<meta property="og:site_name" content="Hyerin Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-24T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Spring Security + OAuth2.0 + Kakao" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2021-08-24/springsecurity(3)/","headline":"Spring Security + OAuth2.0 + Kakao","dateModified":"2021-08-24T00:00:00+09:00","datePublished":"2021-08-24T00:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021-08-24/springsecurity(3)/"},"@type":"BlogPosting","description":"Spring OAuth2.0 Kakao Login","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8RJ9ZZ1LSQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8RJ9ZZ1LSQ', { 'anonymize_ip': false});
</script>


</head>

<body>
  <div class="content-container">
    <header>
  <div class="header-small">
    <a href="http://localhost:4000">Hyerin Blog</a>
  </div>
</header>
<div class="post">
  <div class="post-title">Spring Security + OAuth2.0 + Kakao</div>
  <br />
  <span class="post-date">
    <time>24 Aug 2021</time>
  </span>

  <div class="post-tag">
    <ul>
      
      <li>
        <a href="http://localhost:4000/tags#spring">
          <span>spring</span>
        </a>
      </li>
      
      
      <li>
        <a href="http://localhost:4000/tags#security">
          <span>security</span>
        </a>
      </li>
      
      
      <li>
        <a href="http://localhost:4000/tags#oauth2.0">
          <span>oauth2.0</span>
        </a>
      </li>
      
      
    </ul>
  </div>

  <p><br /></p>

<p>Spring Security에 대한 포스팅은 다음 링크를 참고</p>

<ul>
  <li>
    <p>Spring Security란?: <a href="https://hyerin6.github.io/2021-08-22/springsecurity(1)/">https://hyerin6.github.io/2021-08-22/springsecurity(1)/</a></p>
  </li>
  <li>
    <p>Spring Security 로그인 절차: <a href="https://hyerin6.github.io/2021-08-22/springsecurity(2)/">https://hyerin6.github.io/2021-08-22/springsecurity(2)/</a></p>
  </li>
</ul>

<p><br /></p>

<p>OAuth2.0 로그인을 사용한다면 UsernamePasswordAuthenticationFilter 대신 OAuth2LoginAuthenticationFilter가 호출된다.</p>

<p>두 필터의 상위 클래스는 AbstractAuthenticationProcessingFilter이고,
스프링 시큐리티가 상위 클래스를 호출하면 로그인 방식에 따라 구현체인
UsernamePasswordAuthenticationFilter와 OAuth2LoginAuthenticationFilter가 동작한다.</p>

<p><br /></p>

<p><br /></p>

<h2 id="spring-security-configuration">Spring Security Configuration</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">@EnableWebSecurity</code>는 스프링 시큐리티 설정들을 활성화 시켜준다.</p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">oauth2Client()</code>로 OAuth2 클라이언트 구성 요소를 지정할 수 있다.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">authorizedClientService(authorizedClientService())</code></li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">http.oauth2Login()</code>으로 OAuth2 로그인 관련 처리를 설정할 수 있다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">userService()</code>는 OAuth2 인증 과정에서 Authentication을 생성에 필요한</p>

    <p>OAuth2User를 반환하는 클래스를 지정한다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">customUserType(KakaoOAuth2User.class, SOCIAL_TYPE)</code></p>

    <p>OAuth2User 타입을 지정한다.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">successHandler()</code>는 인증을 성공적으로 마친 경우 처리할 클래스를 지정한다.</p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">failureHandler()</code>는 인증을 실패한 경우 처리할 클래스를 지정한다.</li>
</ul>

<p><br /></p>

<p><br /></p>

<h2 id="oauth2-인증-과정">OAuth2 인증 과정</h2>

<ol>
  <li>
    <p>사용자가 소셜 로그인 성공</p>
  </li>
  <li>
    <p>AbstractAuthenticationProcessingFilter에서 OAuth2 로그인 과정을 호출</p>
  </li>
  <li>
    <p>Resource Server에서 넘겨주는 정보대로</p>

    <p>OAuth2LoginAuthentiationFilter의 <code class="language-plaintext highlighter-rouge">attemptAuthentication()</code>에서 인증 과정을 수행</p>
  </li>
  <li>
    <p>attemptAuthentication() 처리 과정에서 OAuth2AuthenticationToken을 생성하기 위해</p>

    <p>OAuth2LoginAuthenticationProvider의 <code class="language-plaintext highlighter-rouge">authenticate()</code> 호출</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">authenticate()</code> 처리 과정에서 OAuth2User를 생성하기 위해</p>

    <p>OAuth2UserService의 <code class="language-plaintext highlighter-rouge">loadUser()</code> 호출</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">loadUser()</code> 처리 과정에서 OAuth2User를 반환</p>
  </li>
  <li>
    <p>(6)번까지 끝내면 AbstractAuthenticationProcessingFilter에서 SuccessHandler의 <code class="language-plaintext highlighter-rouge">onAuthenticationSuccess()</code>을 호출한다.</p>

    <p>기본적으로 리다이렉션하는 역할인데 커스텀해서 지정할 수 있다.</p>
  </li>
  <li>
    <p>(6)번까지의 과정이 정상적으로 끝나지 않았다면 AbstractAuthenticationProcessingFilter에서 FailureHandler의 <code class="language-plaintext highlighter-rouge">onAuthenticationFailure()</code>을 호출한다.</p>
  </li>
</ol>

<p><br /></p>

<p>여기까지 올바른 요청일 경우의 처리 과정이고 이외의 경우는 다음과 같다.</p>

<ol>
  <li>인증되지 않은 사용자가 인증이 필요한 URL에 접근하려 한다면 authenticationEntityPoint에서 예외 처리</li>
  <li>인증된 사용자가 권한이 부족한 URL에 접근하려 한다면 accessDeniedHandler에서 예외 처리</li>
</ol>

<p><br /></p>

<p><br /></p>

<h2 id="인증-코드-요청">인증 코드 요청</h2>

<p>Spring Security와 OAuth2를 사용해서 자신이 등록한 kakao api의 인증 코드 api를 호출하려면 해당 역할을 하는 endpoint를 알아야 한다.</p>

<p>여기서 endpointsms Filter이고 해당 역할을 하는 Filter는
OAuth2AuthorizationRequestRedirectFilter이다.</p>

<p>이 필터에서 this.authorizationRequestResolver가 registrationID인 kakao 값으로 설정 정보를  조회한다.</p>

<p>인증 코드를 얻기 위해 호출할 API 주를 만들고 해당 주소로 리다이렉션한다.</p>

<p><br /></p>

<p>Spring Security OAuth2 설정을 끝내고 브라우저 주소창에</p>

<p><code class="language-plaintext highlighter-rouge">http://localhost::8080/oauth2/authorization/kakao</code>을 입력하면 카카오톡 로그인 페이지가 뜬다.</p>

<p>사용자가 로그인에 성공하면 카카오에 등록한 Callback URL인 <code class="language-plaintext highlighter-rouge">redirect_uri</code>가 호출된다.</p>

<p><br /></p>

<p><br /></p>

<h2 id="access-token-요청">Access Token 요청</h2>

<p>code를 요청할 때 <code class="language-plaintext highlighter-rouge">redirect_uri</code>을 보내는데 <code class="language-plaintext highlighter-rouge">redirect_uri</code>를 어떻게 처리해서 access token을 얻어올 수 있을까?</p>

<p>직접 Controller에서 token을 얻는 API를 만드는 예제를 본 적이 있는데  프레임워크를 사용하고 있기 때문에 나는 프레임워크를 이용할 것이다.</p>

<p><br /></p>

<p>Access token을 획득하는 역할의 Filter는 OAuth2LoginAuthenticationFilter이다.</p>

<p>OAuth2LoginAuthenticationToken 클래스 변수에 access token과 함께 kakao user 정보도 가지고 있다.</p>

<p><br /></p>

<p><br /></p>

<h2 id="로그인-상태-처리">로그인 상태 처리</h2>

<p>Spring Security는 기본적으로 세션 기반으로 동작한다.</p>

<p>그러나 stateless로 만들고 싶은 경우 OAuth2 인증 처리 후 실행되는 successHandler를 커스텀하면 된다.</p>

<p>이 방법은 현재 프로젝트에서 kakao라는 provider에 의존하는 문제가 있다.</p>

<p>이 의존 문제는 OAuth2UserService의 <code class="language-plaintext highlighter-rouge">loadUser()</code> 메소드에서 <code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code> 타입으로</p>

<p>OAuth2 회원 정보 조회 API의 Response를 파싱하는 코드를 소셜에 맞게 변경해야 한다는 것이다.</p>

<p><br /></p>

<p>이 문제는 CustomUserTypesOAuth2UserService를 사용하여 해결할 수 있다.</p>

<p>Custom User Type을 Map에 담아 파라미터로 넘겨서 사용하고
Map의 Key는 Client의 Registration ID로 설정하는 것이다.</p>

<p>설정은 다음과 같이 하면 된다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
            .anyRequest().authenticated()
            .and()
            .oauth2Client()
            .authorizedClientService(authorizedClientService())
            .and()
            .oauth2Login()
            .userInfoEndpoint()
            .customUserType(KakaoOAuth2User.class, SOCIAL_TYPE)
            .userService(oAuth2UserService())
            .and()
            .successHandler(authenticationSuccessHandler());
    }
}
</code></pre></div></div>

<p><br /></p>

<p><br /></p>

<h2 id="저장된-인증-정보-사용">저장된 인증 정보 사용</h2>

<p>Spring Security는 인증을 하면 인증 정보를 SecurityContextHolder 클래스를 통해 메모리에 저장한다.</p>

<p>세션 키로 메모리에 저장된 인증 정보를 꺼내서 무언가 처리하고 싶다면 다음과 같이 사용하면 된다.</p>

<p><br /></p>

<ul>
  <li>
    <p>controller에서 매개변수로 받는 방법
<code class="language-plaintext highlighter-rouge">@AuthenticationPrincipal OAuth2User oauth2User</code></p>
  </li>
  <li>
    <p>코드에서 얻는 방법
<code class="language-plaintext highlighter-rouge">Authentication auth = SecurityContextHolder.getContext().getAuthentication();</code></p>
  </li>
</ul>

<p><br /></p>

<p>위 방법으로 JWT를 사용하지 않고 구현하려면 구현해야 하는 클래스도 많고 설정해야 하는 부분도 많으며, 문제점도 있다.
그래서 JWT를 함께 사용하는 예제가 많은데 그 이유에 대해서는 다음 게시글에서 확인할 수 있다.</p>

<p><a href="https://hyerin6.github.io/2021-08-24/springsecurity(4)/">https://hyerin6.github.io/2021-08-24/springsecurity(4)/</a></p>



  <br />

  <hr />

  <br />
  <script src="https://utteranc.es/client.js"
        repo="hyerin6/hyerin6.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
  </script>

</div>


    <!-- Documents about icons are here: http://fontawesome.io/icons/ -->
<div class="footer">
  <hr />

  <div class="footer-link">
    
    <a href="https://github.com/hyerin6"><i class="fa fa-github" aria-hidden="true"></i></a>
    
	
    
    <a href="mailto:hyerinn6@gmail.com"><i class="fa fa-envelope" aria-hidden="true"></i></a>
    
  </div>
  © 2022 Hyerin. All rights reserved.
</div>

<br />
<div class="footer">
    <a style="text-align: center;" href="https://hits.seeyoufarm.com">
      <img style="text-align: center;" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fhyerin6.github.io&count_bg=%23010101&title_bg=%23070707&icon=&icon_color=%23E7E7E7&title=visitors&edge_flat=false"/>
    </a>
</div>
  </div>
</body>
</html>
