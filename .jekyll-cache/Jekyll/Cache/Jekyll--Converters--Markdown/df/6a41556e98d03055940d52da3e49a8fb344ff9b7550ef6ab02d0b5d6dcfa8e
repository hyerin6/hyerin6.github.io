I"×(<p><br /></p>

<h2 id="replication">Replication</h2>

<p><img width="500" src="https://nesoy.github.io/assets/posts/20180216/2.png" /></p>

<p>ë‘ ê°œ ì´ìƒì˜ DBMS ì‹œìŠ¤í…œì„ Master/Slaveë¡œ ë‚˜ëˆ ì„œ ë™ì¼í•œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë°©ì‹ì´ë‹¤.</p>

<p>Masterì—ëŠ” ë°ì´í„°ì˜ ìˆ˜ì •ì‚¬í•­ì„ ë°˜ì˜í•˜ê³  Slaveì— ì‹¤ì œ ë°ì´í„°ë¥¼ ë³µì‚¬í•œë‹¤.</p>

<details>
<summary>ë¡œê·¸ê¸°ë°˜ ë³µì œ(binary log)</summary>
<div>

    <ul>
      <li>Statement Based: SQLë¬¸ì¥ì„ ë³µì‚¬í•˜ì—¬ ì§„í–‰
        <ul>
          <li>issue: SQLì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§€ëŠ” ê²½ìš°(Timestamp, UUID, â€¦)</li>
        </ul>
      </li>
      <li>Row Based: SQLì— ë”°ë¼ ë³€ê²½ëœ Row ë¼ì¸ë§Œ ê¸°ë¡í•˜ëŠ” ë°©ì‹
        <ul>
          <li>issue: ë°ì´í„°ê°€ ë§ì´ ë³€ê²½ëœ ê²½ìš° ë°ì´í„° ì»¤ì§ˆ ìˆ˜ ë°–ì— ì—†ë‹¤.</li>
        </ul>
      </li>
      <li>Mixed: ê¸°ë³¸ì ìœ¼ë¡œ Statement Basedë¡œ ì§„í–‰í•˜ë©´ì„œ í•„ìš”ì— ë”°ë¼ Row Basedë¥¼ ì‚¬ìš©í•œë‹¤.</li>
    </ul>

  </div>
</details>

<p><br /></p>

<p>í•˜ë‚˜ì˜ ì„œë²„ì™€ í•˜ë‚˜ì˜ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ìš´ì˜í•˜ê³  ìˆë‹¤ê³  ê°€ì •í•˜ì.   <br />
ì‚¬ìš©ìëŠ” ì ì  ë§ì•„ì§€ê³  ë°ì´í„°ë² ì´ìŠ¤ëŠ” ë§ì€ queryë¥¼ ì²˜ë¦¬í•˜ê¸° í˜ë“  ìƒí™©ì— ì²˜í•˜ê²Œ ëœë‹¤.   <br />
queryì˜ ëŒ€ë¶€ë¶„ì„ ì°¨ì§€í•˜ëŠ” select(read)ë¥¼ ì–´ëŠ ì •ë„ í•´ê²°í•˜ê¸° ìœ„í•´ replication ë°©ë²•ì„ ì‚¬ìš©í•˜ê²Œ ë˜ì—ˆë‹¤.</p>

<p><br />
<br /></p>

<h2 id="replication-ì¥ì ">Replication ì¥ì </h2>
<ul>
  <li>
    <p>ë¶€í•˜ë¶„ì‚°   <br />
ì“°ê¸°/ë³€ê²½ì€ Masterì—ì„œ ì‘ì—…í•˜ì§€ë§Œ ì½ê¸° ì‘ì—…ì€ Master/Slave ë‘˜ë‹¤ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì—  <br />
Slaveì—ì„œ ì½ê¸°ë§Œ í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ê°ê°ì˜ ë¶€í•˜ë¥¼ ë¶„ì‚°í•  ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>ê³ ê°€ìš©ì„± / ì¥ì• ë³µêµ¬   <br />
Masterì—ì„œ ì¥ì•  ë°œìƒ ì‹œ Slaveë¥¼ í†µí•´ ì¥ì•  ë³µêµ¬ ì‹œê°„ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>ë¡œê·¸       <br />
Master ì˜í–¥ì—†ì´ ë¡œê·¸ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆë‹¤.</p>
  </li>
</ul>

<p><br />
<br /></p>

<h2 id="replication-ë‹¨ì ">Replication ë‹¨ì </h2>
<ul>
  <li>
    <p>Master-Slave pair ê´€ë¦¬             <br />
ì„œë²„ê°€ ë§ì•„ì§ˆ ê²½ìš° Masterì™€ Slave ì§ì„ ë§ì¶°ì„œ ê´€ë¦¬í•´ì•¼ í•œë‹¤.</p>
  </li>
  <li>
    <p>ì‹¤íŒ¨ ìƒí™©ì—ì„œì˜ ë³µêµ¬                   <br />
Masterì—ì„œ ì‹¤íŒ¨ ì‹œ Masterì™€ Slaveì˜ êµì²´        <br />
íš©ì€ Slaveì˜ ë°ì´í„°ë¥¼ Masterë¡œ ë³µì‚¬í•˜ëŠ” ì‘ì—…ì„ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•´ì•¼ í•œë‹¤.        <br />
Slaveì—ì„œ ì‹¤íŒ¨í–ˆì„ ë•Œë„ ë§ˆì°¬ê°€ì§€ë‹¤.</p>
  </li>
</ul>

<p><br />
<br /></p>

<h2 id="spring-boot-í”„ë¡œì íŠ¸">Spring Boot í”„ë¡œì íŠ¸</h2>

<h3 id="replicationroutingdatasource">ReplicationRoutingDataSource</h3>
<p>ì—¬ê±° ê°œì˜ ë°ì´í„°ì†ŒìŠ¤ë¥¼ í•˜ë‚˜ë¡œ ë¬¶ì–´ ìë™ìœ¼ë¡œ ë¶„ê¸°ì²˜ë¦¬í•œë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReplicationRoutingDataSource</span> <span class="kd">extends</span> <span class="nc">AbstractRoutingDataSource</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">determineCurrentLookupKey</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">dataSourceType</span> <span class="o">=</span>
            <span class="nc">TransactionSynchronizationManager</span><span class="o">.</span><span class="na">isCurrentTransactionReadOnly</span><span class="o">()</span> <span class="o">?</span> <span class="s">"read"</span> <span class="o">:</span> <span class="s">"write"</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">dataSourceType</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ê·¸ëŸ¬ë‚˜ ì´ ì„¤ì • ë§Œìœ¼ë¡œëŠ” ì›í•˜ëŠ”ëŒ€ë¡œ Master/Slaveì— ë¶„ê¸°ì²˜ë¦¬ë˜ì–´ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">TransactionSynchronizationManager</code>ê°€ <code class="language-plaintext highlighter-rouge">@Transactional</code>ë¡œ ì„ ì–¸ëœ í˜„ì¬ ìŠ¤ë ˆë“œì˜ íŠ¸ëœì­ì…˜ ìƒíƒœë¥¼ ì½ì–´ì˜¤ëŠ”ê²Œ ê°€ëŠ¥í•˜ë”ë¼ë„ ë™ê¸°í™”(synchronation)ì‹œì ê³¼ Connection ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‹œì ì— ë¬¸ì œê°€ ìˆê¸° ë•Œë¬¸ì´ë‹¤.</p>

<p>Springì€ <code class="language-plaintext highlighter-rouge">@Transactional</code> ì–´ë…¸í…Œì´ì…˜ì„ ë§Œë‚˜ë©´ ë‹¤ìŒ ìˆœì„œë¡œ ì¼í•œë‹¤.  <br />
<code class="language-plaintext highlighter-rouge">TransactionManager ì„ ë³„</code>    <br />
â†’ <code class="language-plaintext highlighter-rouge">DataSourceì—ì„œ Connection íšë“</code>      <br />
â†’ <code class="language-plaintext highlighter-rouge">Transaction ë™ê¸°í™”(Synchronization)</code></p>

<p>íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ë§ˆì¹œ ë’¤ì— ì»¤ë„¥ì…˜ì„ íšë“í•´ì•¼ ë‚´ê°€ ì›í•˜ëŠ”ëŒ€ë¡œ ë™ì‘í•˜ëŠ”ë°   <br />
Springì€ ì»¤ë„¥ì…˜ì„ ë¨¼ì € íšë“í•˜ê¸° ë•Œë¬¸ì— Masterì—ì„œë§Œ ì‘ì—…í•œë‹¤.</p>

<p><br /></p>

<h3 id="lazyconnectiondatasoruceproxy">LazyConnectionDataSoruceProxy</h3>
<p>ì»¤ë„¥ì…˜ì„ íšë“í•˜ëŠ” ì‹œì  ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ, ì¦‰ íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ë§ˆì¹œ í›„ì— ì»¤ë„¥ì…˜ì„ íšë“í•˜ê¸° ìœ„í•´ <br />
ReplicationRoutingDataSourceë¥¼ LazyConnectionDataSoruceProxyë¡œ ê°ì‹¸ì¤€ë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">routingDataSource</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">writeDataSource</span><span class="o">,</span> <span class="nc">DataSource</span> <span class="n">readDataSource</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ReplicationRoutingDataSource</span> <span class="n">routingDataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReplicationRoutingDataSource</span><span class="o">();</span>

    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">dataSourceMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;();</span>
    <span class="n">dataSourceMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"write"</span><span class="o">,</span> <span class="n">writeDataSource</span><span class="o">);</span>
    <span class="n">dataSourceMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"read"</span><span class="o">,</span> <span class="n">readDataSource</span><span class="o">);</span>
    <span class="n">routingDataSource</span><span class="o">.</span><span class="na">setTargetDataSources</span><span class="o">(</span><span class="n">dataSourceMap</span><span class="o">);</span>
    <span class="n">routingDataSource</span><span class="o">.</span><span class="na">setDefaultTargetDataSource</span><span class="o">(</span><span class="n">writeDataSource</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">routingDataSource</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">routingDataSource</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">LazyConnectionDataSourceProxy</span><span class="o">(</span><span class="n">routingDataSource</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ì‹¤ì§ˆì ì¸ ì¿¼ë¦¬ ì‹¤í–‰ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ íŠ¸ëœì­ì…˜ì´ ê±¸ë¦¬ë©´ ë¬´ì¡°ê±´ Connection ê°ì²´ë¥¼ í™•ë³´í•˜ëŠ” Springì˜ ë¬¸ì œì ì„ í•´ê²°í•˜ì—¬ íŠ¸ëœì­ì…˜ ì‹œì‘ ì‹œ Connection Proxy ê°ì²´ë¥¼ ë¦¬í„´í•˜ê³  ì‹¤ì œ ì¿¼ë¦¬ê°€ ë°œìƒí•  ë•Œ dataSourceì—ì„œ <code class="language-plaintext highlighter-rouge">getConnection()</code>ì„ í˜¸ì¶œí•˜ëŠ” ì—­í• ì„ í•œë‹¤.</p>

<p><br /></p>

<p><strong>ì‘ë™ ìˆœì„œ</strong>  <br />
TransactionManager ì„ ë³„ <br />
â†’ LazyConnectionDataSourceProxyì—ì„œ <code class="language-plaintext highlighter-rouge">Connection Proxy</code> ê°ì²´ íšë“ <br />
â†’ Transaction ë™ê¸°í™”(Synchronization)<br />
â†’ ì‹¤ì œ ì¿¼ë¦¬ í˜¸ì¶œì‹œ <code class="language-plaintext highlighter-rouge">ReplicationRoutingDataSource.getConnection()</code>/<code class="language-plaintext highlighter-rouge">determineCurrentLookupKey()</code> í˜¸ì¶œ</p>

<p>TransactionManagerë‚˜ ì˜ì† ê³„ì¸µ í”„ë ˆì„ì›Œí¬ëŠ” dataSourceë§Œ ë°”ë¼ë³´ê³  writeDataSource, readDatasource, routingDataSourceëŠ” ì„¤ì •ì—ë§Œ ì¡´ì¬í•  ë¿ ì˜ì† ê³„ì¸µ í”„ë ˆì„ì›Œí¬ëŠ” ì´ ì¡´ì¬ë¥¼ ëª°ë¼ì•¼ í•œë‹¤.</p>

<p><br />
<br /></p>

<h2 id="ì£¼ì˜">ì£¼ì˜</h2>
<p>ì ˆëŒ€ë¡œ í•œë²ˆ ì½ì–´ë“¤ì¸ ì»¤ë„¥ì…˜ì„ readOnly ì„¤ì •ì„ ë°”ê¿”ì„œ ì¬í™œìš©í•˜ë©´ ì•ˆëœë‹¤.  <br />
ì¼ë‹¨ ì‹¤ì œ ì»¤ë„¥ì…˜ì„ íšë“í•˜ë©´ ì¤‘ê°„ì— ì†ì„±ì„ ë°”ê¿”ë„ ë‹¤ë¥¸ ì»¤ë„¥ì…˜ì„ ìƒˆë¡œ ë§ºì§€ ì•ŠëŠ”ë‹¤.</p>

<p>Springì€ propagationì´ <code class="language-plaintext highlighter-rouge">REQUIRES_NEW</code> ì¼ ê²½ìš° ë¹„ë¡ ë™ì¼ DataSourceì—ì„œ ì»¤ë„¥ì…˜ì„ ê°€ì ¸ì˜¤ë”ë¼ë„ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ë§ºê¸° ë•Œë¬¸ì— ì•„ë¬´ ë¬¸ì œ ì—†ì´ ì‘ë™í•œë‹¤. <br />
í•˜ì§€ë§Œ propagationì´ <code class="language-plaintext highlighter-rouge">REQUIRED</code> ì¼ ê²½ìš°ì—ëŠ” ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì„ ìƒì„±í•˜ì§€ë„ ì•Šê³  ìƒˆë¡œìš´ ì„¤ì •ì„ ì ìš©í•˜ì§€ë„ ì•Šìœ¼ë¯€ë¡œ ì£¼ì˜í•´ì•¼ í•œë‹¤.</p>

<p><br />
<br /></p>

<h2 id="ì°¸ê³ ">ì°¸ê³ </h2>

<ul>
  <li><a href="http://egloos.zum.com/kwon37xi/v/5364167">egloos) Java ì—ì„œ DataBase Replication Master/Slave (write/read) ë¶„ê¸° ì²˜ë¦¬í•˜ê¸°</a></li>
  <li><a href="https://github.com/hyerin6/HACKDAY/blob/dev_pk/src/main/java/com/hackday/timeline/config/database/DataSourceConfig.java">ì‹¤ì œ í”„ë¡œì íŠ¸ ì ìš©ëœ ì½”ë“œ</a></li>
  <li><a href="https://www.notion.so/Mysql-Replication-Master-Slave-eb8e807df5474702a3c4c7aa1031d503">í”„ë¡œì íŠ¸ ì§„í–‰ ì •ë¦¬</a></li>
</ul>

:ET